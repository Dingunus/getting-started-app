name: build-docker
on: [push]
jobs:
  build-docker-image:
    runs-on: ubuntu-latest
    steps:
     - run: ls
     - name: Check out repository code
       uses: actions/checkout@v4
     - run: ls
     - run: docker build -t getting-started .
     - run: docker images
     - name: Login to Docker Hub
       uses: docker/login-action@v3
       with:
         username: ${{ vars.DOCKERHUB_USERNAME }}
         password: ${{ secrets.DOCKERHUB_TOKEN }}
     - name: Bump version and push tag
       id: tag_version
       uses: mathieudutour/github-tag-action@v6.2
       with:
         github_token: ${{ secrets.GITHUB_TOKEN }}
     - name: Get next version
       uses: reecetech/version-increment@2024.10.1
       id: version
       with:
         scheme: semver
         increment: patch
     - run: docker tag getting-started dingunus/getting-started:${{ steps.version.outputs.version }}
     - run: docker push dingunus/getting-started:${{ steps.version.outputs.version }}
     - name: Configure AWS credentials
       uses: aws-actions/configure-aws-credentials@v3
       with:
         aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
         aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
         aws-region: eu-west-3
     - run: aws ec2 run-instances --image-id ami-0fcc1d7ed380d3549 --instance-type t2.micro --security-group-ids launch-wizard-1 --key-name g4  --tag-specifications "ResourceType=instance,Tags=[{Key=Name,Value=g4-Cli-Instance-docker}]" --count 1 --user-data "#!/bin/bash\nexec > /var/log/user-data.log 2>&1\nset -x\nsudo yum update -y\nsudo yum install docker\nsudo docker pull dingunus/getting-started:0.0.2\nsudo docker run -p 3000:3000 dingunus/getting-started:0.0.2\nsudo docker ps"
     
